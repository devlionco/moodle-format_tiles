define(["jquery","core/str","format_tiles/edit_browser_storage"],function(a,b,c){var d,e={EDITING_COLLAPSE_SECID:"#collapse",EDITING_COLLAPSE_SEC:".collapse-section",EDITING_EXPAND_SEC:".expand-section",EDITING_EXPAND_SECID:"#expand",ACTIVITY:"li.activity",SECTION_ID:"#section-",TILE_TITLE:"li.section.main .tile_bar_text .inplaceeditable a:not(.quickeditlink)",TILE_BAR_TEXT:".tile_bar_text",SECTION:"ul.section",SECTION_MAIN:"li.section.main",DNDUPLOAD_HIDDEN:"dndupload-hidden",ACTIVITYACTION:"a.cm-edit-action",ACTIONAREA:".actions",EXPAND_ALL_BTNS:".expand-collapse-all-btns a",EXPAND_COLLAPSE_SEC:".expand-collapse-sec ",EDIT_TITLE_PENCIL:".quickeditlink",ICON_PICKER_BTN:".tileiconcontainer",TILE_BAR:".tile_bar",SECTIONACTIONMENU:".section_action_menu",MENU_ACTION:".menu-action"},f={ESCAPE:27,TAB:9,RETURN:13},g={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},h={SECTION:"data-section",ORIG_TITLE:"data-original-title"},i=function(b){var d=a(e.SECTION_ID+b);a(e.SECTION_ID+b+"-content").animate({opacity:0},300),d.find(e.ACTIVITY).slideUp(500),d.find(".section-modchooser").slideUp(500),d.addClass("collapsed").removeClass("expanded"),d.find(".mod-chooser-outer").fadeOut(500),c.setSectionStatus(b,!1)},j=function(a){var b,c,d,e,f,g,h;a.hasClass("tounpinsection")?(b=0,c=1,d="This section is pinned",e="tounpinsection",f="Unpin section",g="fa-lock",h="fa-unlock",a.parents("li.section").addClass("pinned"),a.parents("li.section").find("a.move").first().addClass("hidden")):(b=1,c=0,d="Pin this section to show it in the front",e="topinsection",f="Pin Section",g="fa-unlock",h="fa-lock",a.parents("li.section").removeClass("pinned"),a.parents("li.section").find("a.move").first().removeClass("hidden")),a.attr("href",a.attr("href").replace("pinned="+b,"pinned="+c)),a.attr("title",d),a.attr("data-action",e),a.find(".icon.fa").removeClass(g).addClass(h),a.find(".menu-action-text").text(f)},k=function(){return a(".pinnedsections .tile").length};return{init:function(b,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){d=b,s="1"===s,require(["format_tiles/edit_icon_picker"],function(a){a.init(d,w,x,A)}),y&&require(["format_tiles/edit_course_mod"],function(a){a.init(d,o,z)}),a(document).ready(function(){if(a(e.TILE_BAR_TEXT).on(g.KEYDOWN,function(b){b.keyCode!==f.RETURN||a(b.target).hasClass("form-control")||(window.location=M.cfg.wwwroot+"/course/view.php?id="+d+"&section="+a(b.currentTarget).parent().attr(h.SECTION))}),l&&!n){var b=window.location.search.indexOf("expanded=-1")!==-1,o=a(e.SECTION_MAIN).last().attr("data-section");c.init(u,d,m,q,s,o,b)}if(!n){var p=a("[data-toggle=tooltip]");if(0!==p.length)try{p.tooltip()}catch(r){require(["core/log"],function(a){a.debug(r)})}}a("body").on("click keypress",e.SECTION_MAIN+" "+e.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(b){var c=a(b.target).closest(e.MENU_ACTION),d=c.closest(e.SECTION_MAIN);"hide"!==c.attr("data-action")&&"show"!==c.attr("data-action")||(i(d.attr("data-section")),d.find(e.SECTION).find(e.ACTIVITY).slideUp(300).remove())}),a(".section.pinned").each(function(){var b=a(this).clone();b.addClass("tile").removeClass("section"),b.find(".left.side").remove(),b.find(".right.side").remove(),b.find(".content").remove(),b.find(".sectionname").removeClass("hidden"),b.appendTo(".pinnedsections")}),a(document).on("click","#multi_section_tiles .topinsection",function(){if(k()<4){var b=a(this);b.removeClass("editing_highlight topinsection").addClass("editing_pinning tounpinsection");var c=b.parents(".section").data("section");j(b);var d=a("#section-"+c).clone();d.addClass("pinned tile").removeClass("section editinprogress"),d.find(".lightbox").remove(),d.find(".left.side").remove(),d.find(".right.side").remove(),d.find(".content").remove(),d.find(".sectionname").removeClass("hidden"),d.appendTo(".pinnedsections")}}),a(document).on("click",".tounpinsection",function(){var b=a(this);b.removeClass("editing_pinning tounpinsection").addClass("editing_highlight topinsection");var c=b.parents(".section"),d=c.data("section");c.removeClass("pinned"),j(b),a(".pinnedsections #section-"+d).slideUp(500,function(){a(this).remove()})})})}}});