define(["jquery","core/ajax"],function(a,b){"use strict";var c,d=!1,e={PAGE:"#page",TILE:".tile",TILEID:"#tile-",TILE_COLLAPSED:".tile-collapsed",TILES:".format-tiles.jsenabled ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_ID:"#section-",OPEN_SECTION:".moveablesection:visible",SECTION_ZERO:"#section-0",CONTENT_SECTIONS:".moveablesection"},f=function(){return},g={getContentSectionPositions:function(){var b,c,d=[],f=a(e.OPEN_SECTION);f.css("display","none");var g=1,h=0,i=a(e.TILES).children(e.TILE).not(e.TILE_COLLAPSED).not(".spacer");return i.each(function(d,e){b=a(e).attr("data-section");var f=100;b&&(0===d?h=1:Math.abs(a(e).position().top-a(c).position().top)<=f?h+=1:h=0,h>g&&(g=h),c=e)}),f.css("display","block"),i.each(function(c,e){b=a(e).attr("data-section"),0===d.length||d[d.length-1].sections.length>=g?(d.length>=1&&(d[d.length-1].displayAfterTile=d[d.length-1].sections[d[d.length-1].sections.length-1]),d.push({displayAfterTile:"",sections:[b]})):d[d.length-1].sections.push(b)}),d[d.length-1].displayAfterTile=d[d.length-1].sections[d[d.length-1].sections.length-1],d},moveContentSectionsToPlaces:function(b,c){b.forEach(function(c){c.sections.forEach(function(d){c.displayAfterTile===b[b.length-1].displayAfterTile?a(e.SECTION_ID+d).detach().insertAfter(a("ul.tiles .tile").last()):a(e.SECTION_ID+d).detach().insertAfter(a("#tile-"+c.displayAfterTile))})}),c.forEach(function(a){"function"==typeof a&&a()})},runReOrg:function(b){var c=new a.Deferred;d===!0&&c.reject("Re-org locked"),d=!0;var e=function(){g.moveContentSectionsToPlaces(g.getContentSectionPositions(),[function(){a("body").removeClass("modal-open"),c.resolve("Finished organising tiles"),d=!1}])};return b===!0?setTimeout(function(){e(),c.resolve("Re-org complete")},1e3):(e(),c.resolve("Re-org complete")),c.promise()}},h=function(){a(".block-hider-hide").click(function(){g.runReOrg(!0)}),a(".block-hider-show").click(function(){g.runReOrg(!0)}),a('.navbar button[data-action="toggle-drawer"]').click(function(){setTimeout(function(){g.runReOrg(!0),f()},600)})},i=function(){a(e.TILES).animate({opacity:1},"fast"),a(e.TILE).not(e.SPACER).each(function(b,c){c=a(c),setTimeout(function(){c.animate({opacity:c.hasClass("tile-hidden")||c.hasClass("tile-restricted")?.5:1},"fast")},10*b)}),a(e.SECTION_ZERO).animate({opacity:1},"fast"),a("#page-loading-icon").fadeOut(500).remove()};return{init:function(b,d,f,j){c=b,a(document).ready(function(){h(),"1"===a(e.TILES).css("opacity")&&g.runReOrg().done(function(){0!==d&&a(e.TILEID+d).click()});var b=function(){g.runReOrg().done(function(){0!==d&&0===a(e.OPEN_SECTION).length&&a(e.TILEID+d).click(),i()})};b()})},resizeTilesDivWidth:function(){return f()},runReOrg:function(a){return g.runReOrg(a)}}});